<aside class="sticky top-24 h-[80vh] w-xs space-y-3">
  <h3 class="label">On this page</h3>
  <ul class="tree-view"></ul>
</aside>

<script>
  interface TreeItem {
    label: string;
    id?: string;
    children?: TreeItem[];
  }

  function buildTreeFromHeadings(): TreeItem[] {
    const markdownContent = document.getElementById("markdown-content");
    if (!markdownContent) return [];

    const headings = markdownContent.querySelectorAll("h2, h3");

    const tree: TreeItem[] = [];
    let currentH2: TreeItem | null = null;

    headings.forEach((heading) => {
      const id = heading.id;
      const label = heading.textContent || "";
      const level = heading.tagName.toLowerCase();

      if (level === "h2") {
        currentH2 = {
          label,
          id,
          children: [],
        };
        tree.push(currentH2);
      } else if (level === "h3" && currentH2) {
        currentH2.children!.push({
          label,
          id,
        });
      }
    });

    return tree;
  }

  function renderTreeView(tree: TreeItem[], container: HTMLElement) {
    container.innerHTML = "";

    tree.forEach((item) => {
      const itemId = item.id;
      const hasChildren = item.children && item.children.length > 0;

      const li = document.createElement("li");
      const button = document.createElement("button");
      button.className = "tree-view-item px-4";
      button.setAttribute("data-id", itemId || "");
      button.textContent = item.label;
      li.appendChild(button);

      if (hasChildren) {
        const ul = document.createElement("ul");
        item.children!.forEach((child) => {
          const childLi = document.createElement("li");
          const childButton = document.createElement("button");
          childButton.className = "tree-view-item pr-4 pl-8 text-sm";
          childButton.setAttribute("data-id", child.id || "");
          childButton.textContent = child.label;
          childLi.appendChild(childButton);
          ul.appendChild(childLi);
        });
        li.appendChild(ul);
      }

      container.appendChild(li);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const treeViewContainer = document.querySelector(
      ".tree-view",
    ) as HTMLElement;
    if (!treeViewContainer) return;

    // Build tree from headings and render it
    const tree = buildTreeFromHeadings();
    renderTreeView(tree, treeViewContainer);

    // Set up event listeners after rendering
    const treeItems = document.querySelectorAll(".tree-view-item");

    treeItems.forEach((item) => {
      item.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLElement;
        const sectionId = target.getAttribute("data-id");

        if (sectionId) {
          const section = document.getElementById(sectionId);
          if (section) {
            section.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });

            // Update active state
            treeItems.forEach((i) => {
              i.classList.remove("text-foreground", "border-foreground");
              i.classList.add("text-muted-foreground");
            });
            target.classList.remove("text-muted-foreground");
            target.classList.add("text-foreground", "border-foreground");
          }
        }
      });
    });

    // Update active state on scroll
    const observerOptions = {
      root: null,
      rootMargin: "-20% 0px -70% 0px",
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          if (id) {
            treeItems.forEach((item) => {
              const itemId = item.getAttribute("data-id");
              if (itemId === id) {
                treeItems.forEach((i) => {
                  i.classList.remove("text-foreground", "border-foreground");
                  i.classList.add("text-muted-foreground");
                });
                item.classList.remove("text-muted-foreground");
                item.classList.add("text-foreground", "border-foreground");
              }
            });
          }
        }
      });
    }, observerOptions);

    // Observe all headings with IDs
    document
      .querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]")
      .forEach((heading) => {
        observer.observe(heading);
      });
  });
</script>
